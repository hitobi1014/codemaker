<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.codemaker.common.dao.ComplainMapper"><select id="selectAllComplain" resultType="kr.co.codemaker.common.vo.ComplainVO">
SELECT * FROM COMPLAIN ORDER BY CP_DATE DESC
</select>
<select id="selectComplain" parameterType="kr.co.codemaker.common.vo.ComplainVO" resultType="kr.co.codemaker.common.vo.ComplainVO">
SELECT * 
  FROM COMPLAIN WHERE CP_ID =#{cpId}
</select>
<insert id="insertComplain" parameterType="kr.co.codemaker.common.vo.ComplainVO">
INSERT INTO COMPLAIN VALUES ('CP'||LPAD(CP_SEQ.NEXTVAL,4,'0'), sysdate, #{cpCont}, 'N', '1',#{cpGn}, #{replyId,jdbcType=VARCHAR}, #{qnaId,jdbcType=VARCHAR})
</insert>
<update id="checkComplain" parameterType="kr.co.codemaker.common.vo.ComplainVO">
UPDATE complain set cp_state = 'Y' where cp_ID = #{cpId}
</update>
<select id="selectBlackList" resultType="kr.co.codemaker.common.vo.UserVO">
select * from users a, (select d.user_id ,sum(cp_count) count
  from complain c, 
(select B.QNA_ID , E.REPLY_ID , A.*
   from USERS A, QNA B, REPLY E
  where A.USER_ID = B.USER_ID
    and A.USER_ID = E.REPLY_WRITER) D 
 where D.QNA_ID = C.QNA_ID
    and C.CP_STATE = 'Y'
 group by d.user_id
 having sum(cp_count) >= 3) b where a.user_id = b.user_id



</select>
<select id="selectReplyQna" resultType="String" parameterType="kr.co.codemaker.common.vo.ComplainVO">
SELECT B.QNA_ID
  FROM REPLY A, QNA B WHERE A.QNA_ID = B.QNA_ID AND A.REPLY_ID = #{replyId}
</select>
<update id="insertBlackList" parameterType="kr.co.codemaker.common.vo.UserVO">
UPDATE users set USER_BLACK = 'Y' WHERE USER_ID = #{userId}
</update>
</mapper>